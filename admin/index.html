<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blog Editor — Ament Law Group</title>
<meta name="robots" content="noindex, nofollow">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
  :root { --navy: #0a1530; --navy-light: #162550; --gold: #c8a862; --text: #1e293b; --muted: #64748b; --border: #e2e8f0; --bg: #f8fafc; --white: #fff; --red: #dc2626; --green: #16a34a; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* ── Top bar ─────────────────────────────────── */
  .topbar { background: var(--navy); padding: 0 24px; height: 52px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .topbar-brand { color: #fff; font-weight: 700; font-size: 1rem; letter-spacing: 0.5px; text-decoration: none; }
  .topbar-brand span { color: var(--gold); }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .topbar-right a, .topbar-right button { color: #a1a1aa; font-size: 0.82rem; text-decoration: none; background: none; border: none; cursor: pointer; font-family: inherit; }
  .topbar-right a:hover, .topbar-right button:hover { color: #fff; }

  /* ── Layout ──────────────────────────────────── */
  .container { max-width: 880px; margin: 0 auto; padding: 32px 20px; }
  .page-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
  .page-hdr h1 { font-size: 1.4rem; font-weight: 700; color: var(--navy); }

  /* ── Cards / sections ────────────────────────── */
  .card { background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 24px; margin-bottom: 20px; }

  /* ── Buttons ─────────────────────────────────── */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: 6px; font-size: 0.88rem; font-weight: 600; border: none; cursor: pointer; text-decoration: none; font-family: inherit; transition: background 0.15s; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover { background: var(--navy-light); }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { background: #f1f5f9; }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid #fca5a5; }
  .btn-danger:hover { background: #fef2f2; }
  .btn-sm { padding: 5px 12px; font-size: 0.8rem; }

  /* ── Form elements ───────────────────────────── */
  label { display: block; font-size: 0.82rem; font-weight: 600; color: var(--text); margin-bottom: 5px; }
  label .hint { font-weight: 400; color: var(--muted); font-size: 0.76rem; }
  input[type="text"], input[type="date"], input[type="password"], textarea, select {
    width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
    font-size: 0.92rem; font-family: inherit; background: var(--white); color: var(--text);
  }
  input:focus, textarea:focus, select:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(10,21,48,0.08); }
  .char-count { font-size: 0.72rem; color: var(--muted); margin-top: 3px; }
  .char-count.over { color: var(--red); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { margin-bottom: 18px; }

  /* ── Table ────────────────────────────────────── */
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; padding: 10px 12px; border-bottom: 2px solid var(--border); }
  td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 0.88rem; vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  .post-title { font-weight: 600; color: var(--navy); cursor: pointer; }
  .post-title:hover { text-decoration: underline; }
  .post-slug { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
  .post-actions { text-align: right; white-space: nowrap; }

  /* ── Flash messages ──────────────────────────── */
  .flash { padding: 12px 16px; border-radius: 8px; font-size: 0.88rem; margin-bottom: 16px; }
  .flash-success { background: #f0fdf4; color: var(--green); border: 1px solid #bbf7d0; }
  .flash-error { background: #fef2f2; color: var(--red); border: 1px solid #fecaca; }

  /* ── Login screen ────────────────────────────── */
  .login-wrap { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 52px); }
  .login-card { width: 100%; max-width: 440px; }
  .login-card h2 { font-size: 1.2rem; margin-bottom: 6px; }
  .login-card p { color: var(--muted); font-size: 0.88rem; margin-bottom: 20px; line-height: 1.5; }
  .login-card .steps { font-size: 0.8rem; color: var(--muted); margin-top: 16px; line-height: 1.7; }
  .login-card .steps a { color: var(--navy); }

  /* ── Loading ──────────────────────────────────── */
  .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--navy); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-msg { text-align: center; padding: 40px; color: var(--muted); }

  /* ── Empty state ─────────────────────────────── */
  .empty { text-align: center; padding: 40px; color: var(--muted); }

  /* ── Formatting help ─────────────────────────── */
  details { cursor: pointer; }
  details summary { font-size: 0.82rem; font-weight: 600; color: var(--muted); padding: 4px 0; }
  details .help-content { font-size: 0.8rem; color: var(--muted); margin-top: 12px; line-height: 1.9; }
  details .help-content code { background: #f1f5f9; padding: 1px 5px; border-radius: 3px; font-size: 0.78rem; }

  /* ── EasyMDE overrides ───────────────────────── */
  .EasyMDEContainer .CodeMirror { border-color: var(--border); border-radius: 0 0 6px 6px; min-height: 340px; }
  .EasyMDEContainer .editor-toolbar { border-color: var(--border); border-radius: 6px 6px 0 0; }

  /* ── Responsive ──────────────────────────────── */
  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .page-hdr { flex-direction: column; align-items: flex-start; }
    td:nth-child(3) { display: none; }
    th:nth-child(3) { display: none; }
  }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- ═══ Top Bar ═══════════════════════════════════════════════════════════ -->
<div class="topbar">
  <a href="/admin/" class="topbar-brand" onclick="showList(); return false;">Ament Law <span>Blog Editor</span></a>
  <div class="topbar-right hidden" id="topbarRight">
    <a href="/" target="_blank">← Back to Site</a>
    <button onclick="logout()">Sign Out</button>
  </div>
</div>

<!-- ═══ Login Screen ═════════════════════════════════════════════════════ -->
<div id="loginView" class="login-wrap">
  <div class="card login-card">
    <h2>Sign in to Blog Editor</h2>
    <p>Enter your GitHub personal access token to manage blog posts on ament.law.</p>
    <div class="form-group">
      <label>GitHub Token</label>
      <input type="password" id="tokenInput" placeholder="github_pat_…" autocomplete="off">
    </div>
    <button class="btn btn-primary" onclick="login()" style="width:100%;">Sign In</button>
    <div id="loginError" class="flash flash-error hidden" style="margin-top:12px;"></div>
    <div class="steps">
      <strong>Need a token?</strong><br>
      1. Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub → Settings → Tokens</a><br>
      2. Click "Generate new token"<br>
      3. Name it <em>Ament Blog Editor</em><br>
      4. Repository access → select <em>ament-law-website</em> only<br>
      5. Permissions → Contents → Read and write<br>
      6. Generate and paste above
    </div>
  </div>
</div>

<!-- ═══ Post List ════════════════════════════════════════════════════════ -->
<div id="listView" class="container hidden">
  <div class="page-hdr">
    <h1>Blog Posts</h1>
    <button class="btn btn-primary" onclick="showEditor('new')">+ New Post</button>
  </div>
  <div id="flash"></div>
  <div class="card" style="padding:0; overflow-x:auto;">
    <div id="postListLoading" class="loading-msg"><div class="spinner"></div> Loading posts…</div>
    <table id="postTable" class="hidden">
      <thead><tr><th>Title</th><th>Author</th><th>Date</th><th style="text-align:right;">Actions</th></tr></thead>
      <tbody id="postTableBody"></tbody>
    </table>
    <div id="emptyState" class="empty hidden">
      No blog posts yet. <a href="#" onclick="showEditor('new'); return false;">Write your first post →</a>
    </div>
  </div>
</div>

<!-- ═══ Editor ═══════════════════════════════════════════════════════════ -->
<div id="editorView" class="container hidden">
  <div class="page-hdr">
    <h1 id="editorTitle">New Blog Post</h1>
    <div style="display:flex; gap:8px;">
      <a id="viewOnSiteLink" href="#" target="_blank" class="btn btn-outline btn-sm hidden">View on Site ↗</a>
      <button class="btn btn-outline btn-sm" onclick="showList()">← All Posts</button>
    </div>
  </div>
  <div id="editorFlash"></div>

  <div class="card">
    <div class="form-group">
      <label>Title <span class="hint">— under 60 characters for Google</span></label>
      <input type="text" id="postTitleInput" placeholder="e.g. 5 Things Every PA Homeowner Should Know About Estate Planning">
      <div class="char-count" id="titleCount"></div>
    </div>

    <div class="form-group">
      <label>Description <span class="hint">— 1-2 sentences for search results, under 160 characters</span></label>
      <textarea id="postDescInput" rows="2" placeholder="Brief summary that appears in Google search results…"></textarea>
      <div class="char-count" id="descCount"></div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Publish Date</label>
        <input type="date" id="postDateInput">
      </div>
      <div class="form-group">
        <label>Author</label>
        <select id="postAuthorInput">
          <option value="Katlynn Oliver, Esq.">Katlynn Oliver, Esq.</option>
          <option value="John W. Ament, Esq.">John W. Ament, Esq.</option>
          <option value="W. Robert Ament, Esq.">W. Robert Ament, Esq.</option>
          <option value="Laura Cohen, Esq.">Laura Cohen, Esq.</option>
          <option value="Patrick J. Shannon, Esq.">Patrick J. Shannon, Esq.</option>
          <option value="Ament Law Group">Ament Law Group</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Body</label>
      <textarea id="editor"></textarea>
    </div>

    <div style="display:flex; align-items:center; gap:12px; margin-top:8px; padding-top:20px; border-top:1px solid var(--border); flex-wrap:wrap;">
      <button class="btn btn-primary" id="publishBtn" onclick="publish()">Publish Post</button>
      <span style="font-size:0.8rem; color:var(--muted);">Site rebuilds automatically — live in ~1 minute.</span>
      <button class="btn btn-danger btn-sm hidden" id="deleteBtn" onclick="deletePost()" style="margin-left:auto;">Delete</button>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>Formatting Help</summary>
      <div class="help-content">
        <code>## Heading</code> — Section heading<br>
        <code>**bold**</code> — <strong>Bold text</strong><br>
        <code>*italic*</code> — <em>Italic text</em><br>
        <code>[link text](/contact/)</code> — Internal link<br>
        <code>[link text](https://example.com)</code> — External link<br>
        <code>- Item</code> — Bullet list<br>
        <code>1. Item</code> — Numbered list<br>
        <code>> Quote text</code> — Blockquote<br><br>
        <strong>Tip:</strong> End every post with a call to action like:<br>
        <code>Call [Ament Law Group at (724) 733-3500](/contact/) to discuss your situation.</code>
      </div>
    </details>
  </div>
</div>

<!-- ═══ Scripts ══════════════════════════════════════════════════════════ -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
const REPO = 'jament23/ament-law-website';
const BRANCH = 'main';
const BLOG_PATH = 'blog/posts';
const API = 'https://api.github.com/repos/' + REPO + '/contents/' + BLOG_PATH;

let token = '';
let easyMDE = null;
let currentMode = 'new';
let currentSlug = '';
let currentSha = '';

// ── Auth ──────────────────────────────────────────
function login() {
  var t = document.getElementById('tokenInput').value.trim();
  if (!t) return;
  var errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');

  fetch(API + '?ref=' + BRANCH, {
    headers: ghHeaders(t),
    mode: 'cors',
  })
    .then(function(r) {
      if (r.status === 401 || r.status === 403) throw new Error('Invalid token or no access. Make sure the token has Contents read/write permission on the ament-law-website repo.');
      if (!r.ok) throw new Error('GitHub returned status ' + r.status + '. Try again in a moment.');
      return r.json();
    })
    .then(function() {
      token = t;
      try { localStorage.setItem('ament_blog_token', t); } catch(e) {}
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('topbarRight').classList.remove('hidden');
      showList();
    })
    .catch(function(err) {
      var msg = err.message || String(err);
      if (msg === 'Failed to fetch' || msg.indexOf('NetworkError') !== -1 || msg.indexOf('TypeError') !== -1) {
        msg = 'Network error — the browser could not reach api.github.com. This is usually caused by a Content-Security-Policy header from Cloudflare blocking the connection. Check Cloudflare → Security → Settings for CSP rules, or open browser DevTools (F12) → Console for details.';
      }
      errEl.textContent = msg;
      errEl.classList.remove('hidden');
    });
}

function logout() {
  token = '';
  try { localStorage.removeItem('ament_blog_token'); } catch(e) {}
  document.getElementById('loginView').classList.remove('hidden');
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('editorView').classList.add('hidden');
  document.getElementById('topbarRight').classList.add('hidden');
  document.getElementById('tokenInput').value = '';
}

function ghHeaders(t) {
  return { 'Authorization': 'token ' + (t || token), 'Accept': 'application/vnd.github.v3+json' };
}

// ── Views ─────────────────────────────────────────
function showList() {
  document.getElementById('listView').classList.remove('hidden');
  document.getElementById('editorView').classList.add('hidden');
  loadPosts();
}

function showEditor(mode, slug) {
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('editorView').classList.remove('hidden');
  document.getElementById('editorFlash').innerHTML = '';

  currentMode = mode;
  currentSlug = slug || '';
  currentSha = '';

  if (!easyMDE) {
    easyMDE = new EasyMDE({
      element: document.getElementById('editor'),
      spellChecker: true,
      minHeight: '340px',
      placeholder: 'Write your blog post here…\n\nUse the toolbar above for formatting, or write in Markdown.',
      toolbar: ['bold','italic','heading-2','|','quote','unordered-list','ordered-list','|','link','|','preview','side-by-side','|','undo','redo','|','guide'],
      status: ['lines','words'],
    });
  }

  if (mode === 'new') {
    document.getElementById('editorTitle').textContent = 'New Blog Post';
    document.getElementById('publishBtn').textContent = 'Publish Post';
    document.getElementById('deleteBtn').classList.add('hidden');
    document.getElementById('viewOnSiteLink').classList.add('hidden');
    document.getElementById('postTitleInput').value = '';
    document.getElementById('postDescInput').value = '';
    document.getElementById('postDateInput').value = new Date().toISOString().split('T')[0];
    document.getElementById('postAuthorInput').value = 'Katlynn Oliver, Esq.';
    easyMDE.value('');
    updateCounts();
  } else {
    document.getElementById('editorTitle').textContent = 'Edit Post';
    document.getElementById('publishBtn').textContent = 'Update Post';
    document.getElementById('deleteBtn').classList.remove('hidden');
    loadPostForEdit(slug);
  }
}

// ── Load posts ────────────────────────────────────
function loadPosts() {
  var loading = document.getElementById('postListLoading');
  var table = document.getElementById('postTable');
  var empty = document.getElementById('emptyState');
  var tbody = document.getElementById('postTableBody');

  loading.classList.remove('hidden');
  table.classList.add('hidden');
  empty.classList.add('hidden');

  fetch(API + '?ref=' + BRANCH, { headers: ghHeaders() })
    .then(function(r) {
      if (!r.ok) throw new Error('Failed to load posts');
      return r.json();
    })
    .then(function(files) {
      var mdFiles = files.filter(function(f) {
        return f.name.endsWith('.md') && !f.name.startsWith('_') && f.name !== 'README.md' && f.name !== 'posts.json';
      });

      if (mdFiles.length === 0) {
        loading.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }

      // Fetch each file to get front matter
      var promises = mdFiles.map(function(f) {
        return fetch(f.url, { headers: ghHeaders() })
          .then(function(r) { return r.ok ? r.json() : null; })
          .then(function(data) {
            if (!data) return null;
            var content = decodeBase64(data.content);
            var parsed = parseFrontMatter(content);
            return {
              slug: f.name.replace('.md', ''),
              filename: f.name,
              title: parsed.title || f.name.replace('.md', '').replace(/-/g, ' '),
              date: parsed.date || '',
              author: parsed.author || '',
              sha: data.sha,
            };
          })
          .catch(function() { return null; });
      });

      return Promise.all(promises);
    })
    .then(function(posts) {
      if (!posts) return;
      posts = posts.filter(function(p) { return p !== null; });
      posts.sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });

      tbody.innerHTML = '';
      posts.forEach(function(p) {
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' +
            '<span class="post-title" onclick="showEditor(\'edit\',\'' + p.slug + '\')">' + esc(p.title) + '</span>' +
            '<div class="post-slug">/blog/' + p.slug + '/</div>' +
          '</td>' +
          '<td style="color:var(--muted);">' + esc(p.author) + '</td>' +
          '<td style="color:var(--muted); white-space:nowrap;">' + esc(p.date) + '</td>' +
          '<td class="post-actions">' +
            '<button class="btn btn-outline btn-sm" onclick="showEditor(\'edit\',\'' + p.slug + '\')">Edit</button> ' +
            '<a href="https://www.ament.law/blog/' + p.slug + '/" target="_blank" class="btn btn-outline btn-sm" title="View on site">↗</a>' +
          '</td>';
        tbody.appendChild(tr);
      });

      loading.classList.add('hidden');
      table.classList.remove('hidden');
    })
    .catch(function(err) {
      loading.innerHTML = '<span style="color:var(--red);">Error loading posts: ' + esc(err.message) + '</span>';
    });
}

// ── Load single post for editing ──────────────────
function loadPostForEdit(slug) {
  fetch(API + '/' + slug + '.md?ref=' + BRANCH, { headers: ghHeaders() })
    .then(function(r) {
      if (!r.ok) throw new Error('Post not found');
      return r.json();
    })
    .then(function(data) {
      var content = decodeBase64(data.content);
      var parsed = parseFrontMatter(content);

      currentSha = data.sha;
      document.getElementById('postTitleInput').value = parsed.title || '';
      document.getElementById('postDescInput').value = parsed.description || '';
      document.getElementById('postDateInput').value = parsed.date || '';
      document.getElementById('postAuthorInput').value = parsed.author || 'Katlynn Oliver, Esq.';
      easyMDE.value(parsed.body || '');

      var siteLink = document.getElementById('viewOnSiteLink');
      siteLink.href = 'https://www.ament.law/blog/' + slug + '/';
      siteLink.classList.remove('hidden');

      updateCounts();
    })
    .catch(function(err) {
      flash('editorFlash', 'Could not load post: ' + err.message, 'error');
    });
}

// ── Publish ───────────────────────────────────────
function publish() {
  var title = document.getElementById('postTitleInput').value.trim();
  var desc = document.getElementById('postDescInput').value.trim();
  var date = document.getElementById('postDateInput').value.trim();
  var author = document.getElementById('postAuthorInput').value;
  var body = easyMDE.value().trim();

  if (!title) { flash('editorFlash', 'Title is required.', 'error'); return; }
  if (!body) { flash('editorFlash', 'Post body is required.', 'error'); return; }

  var btn = document.getElementById('publishBtn');
  var origText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Publishing…';

  var fm = '---\ntitle: "' + title + '"\ndescription: "' + desc + '"\ndate: ' + date + '\nauthor: "' + author + '"\n---';
  var fullContent = fm + '\n\n' + body + '\n';

  var filename = (currentMode === 'edit' && currentSlug)
    ? currentSlug + '.md'
    : slugify(title) + '.md';

  var payload = {
    message: (currentMode === 'edit' ? 'Update' : 'Add') + ' blog post: ' + title,
    content: encodeBase64(fullContent),
    branch: BRANCH,
  };
  if (currentSha) payload.sha = currentSha;

  fetch(API + '/' + filename, {
    method: 'PUT',
    headers: Object.assign({}, ghHeaders(), { 'Content-Type': 'application/json' }),
    body: JSON.stringify(payload),
  })
    .then(function(r) {
      if (!r.ok) return r.json().then(function(err) { throw new Error(err.message || 'GitHub API error'); });
      showList();
      setTimeout(function() {
        flash('flash', 'Post ' + (currentMode === 'edit' ? 'updated' : 'published') + '! It will be live on ament.law in about 1 minute.', 'success');
      }, 200);
    })
    .catch(function(err) {
      flash('editorFlash', 'Failed to publish: ' + err.message, 'error');
    })
    .finally(function() {
      btn.disabled = false;
      btn.textContent = origText;
    });
}

// ── Delete ────────────────────────────────────────
function deletePost() {
  if (!confirm('Are you sure you want to delete this post? This cannot be undone.')) return;

  var btn = document.getElementById('deleteBtn');
  btn.disabled = true;
  btn.textContent = 'Deleting…';

  var doDelete = function(sha) {
    fetch(API + '/' + currentSlug + '.md', {
      method: 'DELETE',
      headers: Object.assign({}, ghHeaders(), { 'Content-Type': 'application/json' }),
      body: JSON.stringify({ message: 'Delete blog post: ' + currentSlug, sha: sha, branch: BRANCH }),
    })
      .then(function(r) {
        if (!r.ok) throw new Error('Delete failed');
        showList();
        setTimeout(function() { flash('flash', 'Post deleted.', 'success'); }, 200);
      })
      .catch(function(err) {
        flash('editorFlash', 'Failed to delete: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Delete';
      });
  };

  if (currentSha) {
    doDelete(currentSha);
  } else {
    fetch(API + '/' + currentSlug + '.md?ref=' + BRANCH, { headers: ghHeaders() })
      .then(function(r) { return r.json(); })
      .then(function(data) { doDelete(data.sha); })
      .catch(function() {
        flash('editorFlash', 'Could not find post.', 'error');
        btn.disabled = false;
        btn.textContent = 'Delete';
      });
  }
}

// ── Helpers ───────────────────────────────────────
function parseFrontMatter(content) {
  if (!content.startsWith('---')) return { body: content };
  var parts = content.split('---');
  if (parts.length < 3) return { body: content };
  var fm = parts[1].trim();
  var body = parts.slice(2).join('---').trim();
  var data = { body: body };
  fm.split('\n').forEach(function(line) {
    var idx = line.indexOf(':');
    if (idx === -1) return;
    var key = line.substring(0, idx).trim();
    var val = line.substring(idx + 1).trim().replace(/^["']|["']$/g, '');
    if (['title','description','date','author'].indexOf(key) !== -1) data[key] = val;
  });
  return data;
}

function slugify(title) {
  return title.toLowerCase().trim()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/[\s]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .substring(0, 80);
}

function esc(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function flash(containerId, msg, type) {
  var el = document.getElementById(containerId);
  el.innerHTML = '<div class="flash flash-' + type + '">' + esc(msg) + '</div>';
  setTimeout(function() { el.innerHTML = ''; }, 8000);
}

function decodeBase64(b64) {
  try {
    return decodeURIComponent(escape(atob(b64.replace(/\n/g, ''))));
  } catch(e) {
    return atob(b64.replace(/\n/g, ''));
  }
}

function encodeBase64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

function updateCounts() {
  updateCount(document.getElementById('postTitleInput'), 'titleCount', 60);
  updateCount(document.getElementById('postDescInput'), 'descCount', 160);
}

function updateCount(input, countId, max) {
  var len = (input.value || '').length;
  var el = document.getElementById(countId);
  el.textContent = len + '/' + max + ' characters';
  el.className = 'char-count' + (len > max ? ' over' : '');
}

// Character count listeners
document.getElementById('postTitleInput').addEventListener('input', function() { updateCount(this, 'titleCount', 60); });
document.getElementById('postDescInput').addEventListener('input', function() { updateCount(this, 'descCount', 160); });

// Enter key on token input
document.getElementById('tokenInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') login(); });

// ── Auto-login if token saved ─────────────────────
(function init() {
  var saved = '';
  try { saved = localStorage.getItem('ament_blog_token') || ''; } catch(e) {}
  if (saved) {
    token = saved;
    document.getElementById('loginView').classList.add('hidden');
    document.getElementById('topbarRight').classList.remove('hidden');
    showList();
  }
})();
</script>
</body>
</html>
