---
layout: layouts/base.njk
title: "Allegheny County Assessment Appeal Analyzer"
description: "Is your Allegheny County property over-assessed? Enter your parcel ID to see comparable sales, your implied market value, and estimated annual tax savings if you appeal."
permalink: /assessment-appeal/index.html
---

<style>
/* â”€â”€ Tool layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.appeal-wrap {
  max-width: 920px;
  margin: 0 auto;
  padding: 0 var(--space-md) var(--space-xl);
}

/* â”€â”€ Search card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.appeal-search {
  background: #fff;
  border: 1px solid #e0e4ed;
  border-radius: 10px;
  padding: 28px 32px;
  margin-bottom: 28px;
  box-shadow: 0 2px 8px rgba(15,29,64,.06);
}
.appeal-search h2 {
  font-size: 1.1rem;
  margin: 0 0 6px;
  color: var(--color-heading);
}
.appeal-search p {
  font-size: 0.9rem;
  color: #666;
  margin: 0 0 18px;
}
.search-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: flex-end;
}
.search-row input[type="text"] {
  flex: 1;
  min-width: 200px;
  padding: 11px 14px;
  border: 1.5px solid #c8cee0;
  border-radius: 7px;
  font-size: 1rem;
  font-family: var(--font-body);
  color: var(--color-heading);
  letter-spacing: .04em;
  transition: border-color .15s;
}
.search-row input[type="text"]:focus {
  outline: none;
  border-color: var(--color-accent);
}
.search-row button {
  padding: 11px 26px;
  background: var(--color-accent);
  color: #fff;
  border: none;
  border-radius: 7px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s;
}
.search-row button:hover { background: var(--color-accent-hover); }
.search-row button:disabled { opacity: .55; cursor: not-allowed; }

/* â”€â”€ Settings row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid #eef0f5;
}
.setting-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.setting-group label {
  font-size: 0.78rem;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: .05em;
}
.setting-group select,
.setting-group input[type="number"] {
  padding: 7px 10px;
  border: 1.5px solid #c8cee0;
  border-radius: 6px;
  font-size: 0.88rem;
  font-family: var(--font-body);
  color: var(--color-heading);
  background: #fff;
  min-width: 130px;
}
.setting-group select:focus,
.setting-group input[type="number"]:focus {
  outline: none;
  border-color: var(--color-accent);
}

/* â”€â”€ Status / error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#appeal-status {
  display: none;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 0.9rem;
  margin-bottom: 20px;
}
#appeal-status.loading {
  display: block;
  background: #f0f4ff;
  color: #334;
  border: 1px solid #c7d2fe;
}
#appeal-status.error {
  display: block;
  background: #fef2f2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* â”€â”€ Metrics strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.metrics-strip {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 14px;
  margin-bottom: 24px;
}
.metric-card {
  background: #fff;
  border: 1px solid #e0e4ed;
  border-radius: 10px;
  padding: 18px 20px;
  box-shadow: 0 2px 8px rgba(15,29,64,.05);
}
.metric-card .metric-label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: #888;
  margin-bottom: 6px;
}
.metric-card .metric-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-heading);
  line-height: 1.1;
}
.metric-card .metric-note {
  font-size: 0.75rem;
  color: #999;
  margin-top: 4px;
}
.metric-card.highlight {
  border-color: var(--color-accent);
  background: #f5f7fd;
}
.metric-card.highlight .metric-value { color: var(--color-accent); }
.metric-card.savings-positive {
  border-color: #15803d;
  background: #f0fdf4;
}
.metric-card.savings-positive .metric-value { color: #15803d; }
.metric-card.savings-none {
  border-color: #d1d5db;
  background: #f9fafb;
}
.metric-card.savings-none .metric-value { color: #6b7280; }

/* â”€â”€ Section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-section {
  background: #fff;
  border: 1px solid #e0e4ed;
  border-radius: 10px;
  padding: 24px 28px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(15,29,64,.05);
}
.result-section h3 {
  font-size: 1rem;
  font-weight: 700;
  color: var(--color-heading);
  margin: 0 0 16px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eef0f5;
  text-transform: uppercase;
  letter-spacing: .04em;
  font-size: .8rem;
}

/* â”€â”€ Comparables table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.comps-table-wrap { overflow-x: auto; }
.comps-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.comps-table th {
  background: var(--color-heading);
  color: #fff;
  padding: 9px 12px;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .04em;
  white-space: nowrap;
}
.comps-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #eef0f5;
  color: var(--color-body);
  vertical-align: top;
}
.comps-table tr:last-child td { border-bottom: none; }
.comps-table tr:hover td { background: #f9fafc; }
.comps-table .td-price { font-weight: 600; color: var(--color-heading); white-space: nowrap; }
.comps-table .td-addr { max-width: 200px; }
.comps-table .td-date { white-space: nowrap; color: #666; }

/* â”€â”€ Variance badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.variance-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 700;
}
.variance-over  { background: #fef2f2; color: #991b1b; }
.variance-fair  { background: #f0fdf4; color: #15803d; }
.variance-under { background: #eff6ff; color: #1d4ed8; }

/* â”€â”€ CTA box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.appeal-cta {
  background: var(--color-heading);
  color: #fff;
  border-radius: 12px;
  padding: 32px 36px;
  margin-top: 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  flex-wrap: wrap;
}
.appeal-cta h3 { color: #fff; margin: 0 0 6px; font-size: 1.2rem; }
.appeal-cta p  { color: rgba(255,255,255,.8); margin: 0; font-size: 0.93rem; }
.appeal-cta-btns { display: flex; gap: 10px; flex-wrap: wrap; flex-shrink: 0; }

/* â”€â”€ Disclaimer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.appeal-disclaimer {
  font-size: 0.78rem;
  color: #999;
  line-height: 1.5;
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid #eef0f5;
}

/* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media print {
  .simple-header, .appeal-search .settings-row, .search-row button,
  .appeal-cta, nav, footer, .chat-widget { display: none !important; }
  .appeal-wrap { padding: 0; }
  .result-section, .metric-card { box-shadow: none; border: 1px solid #ccc; }
}
</style>

<section class="simple-header">
  <div class="container">
    <h1>Assessment Appeal Analyzer</h1>
    <p>Find out if your Allegheny County property is over-assessed â€” and what you could save.</p>
  </div>
</section>

<div class="appeal-wrap">

  {# â”€â”€ Search & Settings â”€â”€ #}
  <div class="appeal-search">
    <h2>Enter Your Parcel ID</h2>
    <p>Your 16-digit Parcel ID is on your tax bill or at <a href="https://www2.alleghenycounty.us/RealEstate/Search.aspx" target="_blank" rel="noopener">Allegheny County Real Estate</a>. Dashes are optional.</p>
    <div class="search-row">
      <input type="text" id="parcel-input" placeholder="e.g. 0973B00334000000"
             maxlength="20" autocomplete="off" autocorrect="off" spellcheck="false"
             onkeydown="if(event.key==='Enter') runAnalysis()">
      <button id="analyze-btn" onclick="runAnalysis()">Analyze Property</button>
    </div>
    <div class="settings-row">
      <div class="setting-group">
        <label>Sq. Ft. Variance</label>
        <select id="sqft-variance">
          <option value="10">Â± 10%</option>
          <option value="20" selected>Â± 20%</option>
          <option value="30">Â± 30%</option>
          <option value="50">Â± 50%</option>
        </select>
      </div>
      <div class="setting-group">
        <label>Sales Lookback</label>
        <select id="lookback">
          <option value="6">6 months</option>
          <option value="12" selected>12 months</option>
          <option value="18">18 months</option>
          <option value="24">24 months</option>
        </select>
      </div>
      <div class="setting-group">
        <label>Muni + County Millage</label>
        <input type="number" id="muni-millage" value="9.73" step="0.01" min="0" max="30"
               title="Combined municipal + county millage rate. School millage is looked up automatically.">
      </div>
    </div>
  </div>

  {# â”€â”€ Status message â”€â”€ #}
  <div id="appeal-status"></div>

  {# â”€â”€ Results (hidden until search) â”€â”€ #}
  <div id="appeal-results" style="display:none;">

    {# Property header #}
    <div style="margin-bottom:20px;">
      <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#888;margin-bottom:4px;">Subject Property</div>
      <div id="result-address" style="font-size:1.3rem;font-weight:700;color:var(--color-heading);"></div>
      <div id="result-municipality" style="font-size:.9rem;color:#666;margin-top:2px;"></div>
    </div>

    {# Metrics strip #}
    <div class="metrics-strip">
      <div class="metric-card">
        <div class="metric-label">Current Assessment</div>
        <div class="metric-value" id="m-assessment">â€”</div>
        <div class="metric-note">County record (CLR-adjusted)</div>
      </div>
      <div class="metric-card highlight">
        <div class="metric-label">Implied Market Value</div>
        <div class="metric-value" id="m-implied">â€”</div>
        <div class="metric-note" id="m-clr-note">At 2026 CLR of 50.14%</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Avg Comparable Sale</div>
        <div class="metric-value" id="m-avg-sale">â€”</div>
        <div class="metric-note" id="m-comp-count">â€”</div>
      </div>
      <div class="metric-card" id="m-savings-card">
        <div class="metric-label">Est. Annual Tax Savings</div>
        <div class="metric-value" id="m-savings">â€”</div>
        <div class="metric-note" id="m-savings-note">â€”</div>
      </div>
    </div>

    {# Value Variance detail #}
    <div class="result-section">
      <h3>Market Analysis</h3>
      <div style="display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start;">
        <div style="flex:1;min-width:220px;">
          <div style="margin-bottom:12px;">
            <span style="font-size:.8rem;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:.04em;">Value Variance</span><br>
            <span id="variance-badge" class="variance-badge" style="margin-top:5px;font-size:1rem;"></span>
          </div>
          <p id="variance-explanation" style="font-size:.88rem;color:#555;margin:0;line-height:1.6;"></p>
        </div>
        <div style="flex:1;min-width:220px;">
          <div style="font-size:.8rem;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;">Tax Estimate Breakdown</div>
          <table style="font-size:.85rem;width:100%;border-collapse:collapse;">
            <tr><td style="padding:3px 0;color:#555;">School Millage</td><td id="td-school" style="text-align:right;font-weight:600;color:var(--color-heading);">â€”</td></tr>
            <tr><td style="padding:3px 0;color:#555;">Muni + County Millage</td><td id="td-muni" style="text-align:right;font-weight:600;color:var(--color-heading);">â€”</td></tr>
            <tr style="border-top:1px solid #eef0f5;"><td style="padding:5px 0 3px;font-weight:700;color:var(--color-heading);">Total Millage</td><td id="td-total" style="text-align:right;font-weight:700;color:var(--color-heading);">â€”</td></tr>
            <tr><td style="padding:3px 0;color:#555;">Current Annual Tax</td><td id="td-current-tax" style="text-align:right;font-weight:600;">â€”</td></tr>
            <tr><td style="padding:3px 0;color:#555;">Tax at Comparable Value</td><td id="td-target-tax" style="text-align:right;font-weight:600;">â€”</td></tr>
          </table>
        </div>
      </div>
    </div>

    {# Comparable Sales Table #}
    <div class="result-section" id="comps-section">
      <h3>Comparable Sales Evidence</h3>
      <div class="comps-table-wrap">
        <table class="comps-table" id="comps-table">
          <thead>
            <tr>
              <th>Address</th>
              <th>Sale Price</th>
              <th>Sale Date</th>
              <th>Sq. Ft.</th>
              <th>Grade</th>
              <th>Parcel ID</th>
            </tr>
          </thead>
          <tbody id="comps-tbody"></tbody>
        </table>
      </div>
      <div id="comps-none" style="display:none;font-size:.9rem;color:#888;padding:12px 0;">
        No comparable sales found within the selected variance and lookback period. Try widening the sq. ft. variance or extending the lookback.
      </div>
    </div>

    {# Print button #}
    <div style="text-align:right;margin-bottom:4px;">
      <button onclick="window.print()" style="background:none;border:1px solid #d1d5db;border-radius:6px;padding:8px 18px;font-size:.85rem;font-weight:600;color:#555;cursor:pointer;">
        ðŸ–¨ Print / Save as PDF
      </button>
    </div>

  </div>{# /appeal-results #}

  {# â”€â”€ CTA â”€â”€ #}
  <div class="appeal-cta">
    <div>
      <h3>Ready to appeal? We can help.</h3>
      <p>Our attorneys represent property owners in Allegheny County assessment appeals before the Board of Property Assessment Appeals and the Court of Common Pleas.</p>
    </div>
    <div class="appeal-cta-btns">
      <a href="/contact/" class="cta-button-light">Schedule a Consultation</a>
      <a href="tel:724-733-3500" class="cta-button-outline">Call (724) 733-3500</a>
    </div>
  </div>

  <div class="appeal-disclaimer">
    <strong>Disclaimer:</strong> This tool is for informational purposes only and does not constitute legal advice. Assessment data is sourced from the Western Pennsylvania Regional Data Center (WPRDC) and may not reflect recent changes. Tax estimates are approximations only. Actual appeal outcomes depend on many factors. Consult an attorney before filing an appeal.
  </div>

</div>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLR = 0.5014;  // 2026 Common Level Ratio
const WPRDC_BASE = "https://data.wprdc.org/api/3/action/datastore_search";
const ASSESSMENT_RESOURCE = "65855e14-549e-4992-b5be-d629afc676fa";

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let millageRates = [];  // loaded once from /api/millage

// â”€â”€ Millage loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMillage() {
  try {
    const resp = await fetch("/api/millage");
    if (resp.ok) {
      const data = await resp.json();
      if (data.rates && data.rates.length > 0) {
        millageRates = data.rates;
      }
    }
  } catch (e) {
    // silently fall back to manual millage input
  }
}

function getSchoolMillage(muniName) {
  if (!millageRates.length) return null;
  const q = (muniName || "").toLowerCase();
  const match = millageRates.find(r =>
    r.municipality && r.municipality.toLowerCase().includes(q)
  );
  return match ? match.millage : null;
}

// â”€â”€ WPRDC fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWPRDC(filters, limit = 1) {
  const params = new URLSearchParams({
    resource_id: ASSESSMENT_RESOURCE,
    limit: limit,
    filters: JSON.stringify(filters),
  });
  const resp = await fetch(`${WPRDC_BASE}?${params}`);
  if (!resp.ok) throw new Error(`WPRDC returned ${resp.status}`);
  const data = await resp.json();
  if (!data.success) throw new Error(data.error || "WPRDC query failed");
  return data.result.records;
}

async function fetchMuniRecords(muniCode, muniDesc, limit = 5000) {
  // Try by code first (more reliable), fall back to name
  const filters = muniCode ? { MUNICODE: String(muniCode) } : { MUNIDESC: muniDesc.toUpperCase() };
  const params = new URLSearchParams({
    resource_id: ASSESSMENT_RESOURCE,
    limit: limit,
    filters: JSON.stringify(filters),
  });
  const resp = await fetch(`${WPRDC_BASE}?${params}`);
  if (!resp.ok) throw new Error(`WPRDC returned ${resp.status}`);
  const data = await resp.json();
  return data.result.records || [];
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt$(n) {
  return n == null ? "â€”" : "$" + Math.round(n).toLocaleString();
}
function fmtMillage(n) {
  return n == null ? "â€”" : n.toFixed(2);
}
function setStatus(msg, type) {
  const el = document.getElementById("appeal-status");
  el.textContent = msg;
  el.className = type; // "loading" | "error" | ""
  el.style.display = msg ? "block" : "none";
}
function setMetric(id, val) {
  document.getElementById(id).textContent = val;
}

// â”€â”€ Main analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
  const rawId = document.getElementById("parcel-input").value.replace(/[-\s]/g, "").trim().toUpperCase();
  if (rawId.length < 10) {
    setStatus("Please enter a valid parcel ID (at least 10 digits).", "error");
    return;
  }

  const sqftVar    = parseInt(document.getElementById("sqft-variance").value) / 100;
  const lookback   = parseInt(document.getElementById("lookback").value);
  const muniMillage = parseFloat(document.getElementById("muni-millage").value) || 9.73;

  document.getElementById("analyze-btn").disabled = true;
  document.getElementById("appeal-results").style.display = "none";
  setStatus("Retrieving assessment recordâ€¦", "loading");

  try {
    // 1. Fetch subject property
    const records = await fetchWPRDC({ PARID: rawId }, 1);
    if (!records.length) {
      setStatus("Parcel ID not found. Check the ID and try again.", "error");
      document.getElementById("analyze-btn").disabled = false;
      return;
    }

    const s = records[0];
    const address    = (s.PROPERTYADDRESS || "Unknown Address").trim();
    const muniName   = (s.MUNIDESC || "").trim();
    const muniCode   = s.MUNICODE;
    const curAssess  = parseFloat(s.FAIRMARKETTOTAL) || 0;
    const subjectSqft = parseFloat(s.FINISHEDLIVINGAREA) || null;

    // 2. Look up school millage (auto or fallback)
    const schoolMillage = getSchoolMillage(muniName) || 16.0; // reasonable fallback
    const totalMillage  = schoolMillage + muniMillage;
    const taxRate       = totalMillage / 1000;
    const impliedVal    = curAssess / CLR;

    // Show address immediately
    setStatus("Running market analysisâ€¦", "loading");

    // 3. Fetch municipality comparables
    const allRecords = await fetchMuniRecords(muniCode, muniName, 5000);

    // 4. Filter comparables
    const cutoffDate = new Date();
    cutoffDate.setMonth(cutoffDate.getMonth() - lookback);

    let comps = allRecords.filter(r => {
      const price = parseFloat(r.SALEPRICE);
      const saleDate = new Date(r.SALEDATE);
      if (isNaN(price) || price < 10000) return false;
      if (isNaN(saleDate.getTime()) || saleDate < cutoffDate) return false;
      if (r.PARID === rawId) return false;
      if (subjectSqft) {
        const sqft = parseFloat(r.FINISHEDLIVINGAREA);
        if (isNaN(sqft)) return false;
        if (sqft < subjectSqft * (1 - sqftVar) || sqft > subjectSqft * (1 + sqftVar)) return false;
      }
      return true;
    });

    // Sort newest first, take top 10 for display
    comps.sort((a, b) => new Date(b.SALEDATE) - new Date(a.SALEDATE));
    const displayComps = comps.slice(0, 10);
    const avgPrice = comps.length
      ? comps.reduce((sum, r) => sum + parseFloat(r.SALEPRICE), 0) / comps.length
      : null;

    const targetAssess = avgPrice ? avgPrice * CLR : null;
    const savings = (avgPrice && targetAssess < curAssess)
      ? (curAssess - targetAssess) * taxRate
      : 0;

    const variancePct = avgPrice ? ((impliedVal - avgPrice) / avgPrice) * 100 : null;

    // â”€â”€ Populate UI â”€â”€
    setStatus("", "");

    // Header
    document.getElementById("result-address").textContent = address;
    document.getElementById("result-municipality").textContent =
      `${muniName}${muniCode ? " Â· Parcel " + rawId : ""}`;

    // Metrics
    setMetric("m-assessment", fmt$(curAssess));
    setMetric("m-implied",    fmt$(impliedVal));
    setMetric("m-avg-sale",   avgPrice ? fmt$(avgPrice) : "No comps");
    setMetric("m-comp-count", comps.length
      ? `${comps.length} sale${comps.length !== 1 ? "s" : ""} in ${lookback} months`
      : "No comparable sales found");

    // Savings card
    const savingsCard = document.getElementById("m-savings-card");
    if (savings > 0) {
      setMetric("m-savings", fmt$(savings));
      setMetric("m-savings-note", "Appeal likely recommended");
      savingsCard.className = "metric-card savings-positive";
    } else if (avgPrice) {
      setMetric("m-savings", "$0");
      setMetric("m-savings-note", "Assessment appears fair");
      savingsCard.className = "metric-card savings-none";
    } else {
      setMetric("m-savings", "â€”");
      setMetric("m-savings-note", "Insufficient comp data");
      savingsCard.className = "metric-card";
    }

    // Variance badge + explanation
    const vBadge = document.getElementById("variance-badge");
    const vExpl  = document.getElementById("variance-explanation");
    if (variancePct !== null) {
      const sign = variancePct > 0 ? "+" : "";
      vBadge.textContent = `${sign}${variancePct.toFixed(1)}%`;
      if (variancePct > 10) {
        vBadge.className = "variance-badge variance-over";
        vExpl.textContent = `Your implied value is ${sign}${variancePct.toFixed(1)}% above comparable sales. This suggests your property may be over-assessed, which typically supports an appeal.`;
      } else if (variancePct < -10) {
        vBadge.className = "variance-badge variance-under";
        vExpl.textContent = `Your implied value is ${variancePct.toFixed(1)}% below comparable sales. Your property appears to be assessed conservatively.`;
      } else {
        vBadge.className = "variance-badge variance-fair";
        vExpl.textContent = `Your implied value is within Â±10% of comparable sales. Your assessment appears to be in line with market values.`;
      }
    } else {
      vBadge.textContent = "â€”";
      vBadge.className = "variance-badge";
      vExpl.textContent = "Not enough comparable sales to calculate a variance. Try widening filters.";
    }

    // Tax breakdown
    setMetric("td-school",       fmtMillage(schoolMillage));
    setMetric("td-muni",         fmtMillage(muniMillage));
    setMetric("td-total",        fmtMillage(totalMillage));
    document.getElementById("td-current-tax").textContent  = fmt$(curAssess * taxRate);
    document.getElementById("td-target-tax").textContent   = targetAssess ? fmt$(targetAssess * taxRate) : "â€”";

    // Comparables table
    const tbody = document.getElementById("comps-tbody");
    tbody.innerHTML = "";
    if (displayComps.length) {
      document.getElementById("comps-section").style.display = "";
      document.getElementById("comps-none").style.display = "none";
      displayComps.forEach(r => {
        const tr = document.createElement("tr");
        const saleDate = r.SALEDATE ? r.SALEDATE.substring(0, 10) : "â€”";
        const sqft = parseFloat(r.FINISHEDLIVINGAREA);
        tr.innerHTML = `
          <td class="td-addr">${(r.PROPERTYADDRESS || "â€”").trim()}</td>
          <td class="td-price">${fmt$(parseFloat(r.SALEPRICE))}</td>
          <td class="td-date">${saleDate}</td>
          <td>${isNaN(sqft) ? "â€”" : sqft.toLocaleString()}</td>
          <td>${r.GRADE || "â€”"}</td>
          <td style="font-size:.78rem;color:#888;">${r.PARID || "â€”"}</td>`;
        tbody.appendChild(tr);
      });
    } else {
      document.getElementById("comps-section").style.display = "";
      document.getElementById("comps-none").style.display = "block";
    }

    document.getElementById("appeal-results").style.display = "block";
    document.getElementById("appeal-results").scrollIntoView({ behavior: "smooth", block: "start" });

  } catch (err) {
    setStatus("Error: " + (err.message || "Could not retrieve data. Please try again."), "error");
    console.error(err);
  }

  document.getElementById("analyze-btn").disabled = false;
}

// Load millage rates in the background on page load
loadMillage();
</script>
